<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Mountain Tracker Pro - Strava-like Hiking Dashboard</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* CSS SESUAI PERMINTAAN (TIDAK DIUBAH) */
    :root { 
      --strava-orange: #FC4C02;
      --strava-dark: #1C1C1E;
      --strava-light: #F8F9FA;
      --primary: #FC4C02;
      --secondary: #2E7D32;
      --accent: #1565C0;
      --dark-bg: #0D1B1E; 
      --card-bg: rgba(28, 28, 30, 0.95);
      --text-light: #F5F5F5;
      --text-dim: #B0BEC5;
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #F44336;
      --elevation-low: #2E7D32;
      --elevation-medium: #FF9800;
      --elevation-high: #F44336;
    }
    
    body { 
      margin: 0; 
      padding: 0; 
      font-family: 'Open Sans', sans-serif; 
      background: var(--strava-dark);
      color: var(--text-light);
      height: 100vh;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    #map { 
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
      height: 100vh;
      width: 100vw;
    }

    .main-container {
      position: relative;
      height: 100vh;
      width: 100vw;
      z-index: 2;
      pointer-events: none;
    }

    .dashboard-container {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      max-height: calc(100vh - 20px);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      pointer-events: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--strava-orange) rgba(255, 255, 255, 0.1);
      padding-right: 5px;
    }

    .dashboard-container::-webkit-scrollbar { width: 6px; }
    .dashboard-container::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px; }
    .dashboard-container::-webkit-scrollbar-thumb { background: var(--strava-orange); border-radius: 3px; }
    
    .dashboard-container > * { pointer-events: auto; }

    .dashboard-header {
      background: var(--card-bg);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: clamp(12px, 3vw, 20px);
      border-radius: clamp(12px, 3vw, 20px);
      color: var(--text-light);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: all 0.3s ease;
      animation: slideInDown 0.6s ease-out;
      flex-shrink: 0;
    }

    .header-top {
      display: flex; flex-direction: column; gap: 12px; margin-bottom: clamp(12px, 3vw, 20px);
      padding-bottom: clamp(10px, 2vw, 15px); border-bottom: 2px solid rgba(252, 76, 2, 0.3);
    }
    @media (min-width: 768px) { .header-top { flex-direction: row; align-items: center; justify-content: space-between; } }
    
    .logo-title { display: flex; align-items: center; gap: clamp(10px, 2vw, 15px); }
    .logo-icon {
      width: clamp(36px, 8vw, 45px); height: clamp(36px, 8vw, 45px); min-width: 36px; min-height: 36px;
      background: linear-gradient(135deg, var(--strava-orange), #FF8C00); border-radius: clamp(8px, 2vw, 12px);
      display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(252, 76, 2, 0.4);
    }
    .logo-icon i { font-size: clamp(18px, 4vw, 22px); color: white; }
    
    .title-section h1 {
      margin: 0; font-size: clamp(16px, 4vw, 22px); font-weight: 800; font-family: 'Montserrat', sans-serif;
      background: linear-gradient(90deg, var(--strava-orange), #FF8C00); -webkit-background-clip: text; background-clip: text; color: transparent;
      letter-spacing: 0.5px; line-height: 1.2;
    }
    .title-section p { margin: 4px 0 0 0; font-size: clamp(10px, 2.5vw, 12px); color: var(--text-dim); letter-spacing: 0.3px; }
    
    .live-indicator {
      display: flex; align-items: center; gap: 6px; background: rgba(252, 76, 2, 0.15);
      padding: clamp(5px, 1.5vw, 8px) clamp(10px, 2vw, 15px); border-radius: 30px; border: 1px solid rgba(252, 76, 2, 0.3);
      animation: pulseGlow 2s infinite; align-self: flex-start;
    }
    .live-dot { width: clamp(8px, 2vw, 10px); height: clamp(8px, 2vw, 10px); background-color: var(--strava-orange); border-radius: 50%; animation: pulse 1.5s infinite; }
    .live-text { font-size: clamp(10px, 2.5vw, 12px); font-weight: 700; letter-spacing: 0.5px; white-space: nowrap; }

    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: clamp(8px, 2vw, 15px); margin-bottom: clamp(8px, 2vw, 15px); }
    @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.05); padding: clamp(12px, 3vw, 18px); border-radius: clamp(10px, 3vw, 16px);
      text-align: center; border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; position: relative; overflow: hidden; flex-shrink: 0;
    }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, var(--strava-orange), #FF8C00); }
    
    .stat-value { font-size: clamp(18px, 5vw, 24px); font-weight: 800; font-family: 'Montserrat', sans-serif; color: var(--text-light); margin: clamp(6px, 2vw, 10px) 0 clamp(3px, 1vw, 5px); display: block; word-break: break-word; }
    .stat-label { font-size: clamp(10px, 2.5vw, 12px); color: var(--text-dim); text-transform: uppercase; letter-spacing: clamp(0.5px, 0.5vw, 1px); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: clamp(4px, 1vw, 8px); }
    .stat-label i { font-size: clamp(10px, 2.5vw, 12px); color: var(--strava-orange); }

    .distance-progress { margin-top: clamp(10px, 3vw, 15px); background: rgba(255, 255, 255, 0.03); padding: clamp(10px, 3vw, 15px); border-radius: clamp(8px, 2vw, 12px); border: 1px solid rgba(255, 255, 255, 0.05); flex-shrink: 0; }
    .progress-header { display: flex; flex-direction: column; gap: 8px; margin-bottom: clamp(8px, 2vw, 10px); }
    @media (min-width: 480px) { .progress-header { flex-direction: row; justify-content: space-between; align-items: center; gap: 0; } }
    
    .progress-title { font-size: clamp(11px, 3vw, 13px); font-weight: 600; color: var(--text-light); display: flex; align-items: center; gap: clamp(6px, 1.5vw, 8px); }
    .progress-title i { color: var(--strava-orange); font-size: clamp(12px, 3vw, 14px); }
    .progress-percentage { font-size: clamp(12px, 3vw, 14px); font-weight: 700; color: var(--strava-orange); }
    .progress-bar { height: clamp(6px, 2vw, 8px); background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; margin-bottom: clamp(6px, 2vw, 8px); }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--strava-orange), #FF8C00); border-radius: 4px; width: 0%; transition: width 1s ease-out; }
    .progress-labels { display: flex; justify-content: space-between; font-size: clamp(9px, 2.5vw, 11px); color: var(--text-dim); }

    .elevation-panel {
      background: var(--card-bg); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%);
      padding: clamp(12px, 3vw, 18px); border-radius: clamp(12px, 3vw, 18px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.08); animation: fadeIn 0.8s ease-out 0.3s both; margin-top: 8px; flex-shrink: 0;
    }
    .elevation-header { display: flex; flex-direction: column; gap: 10px; margin-bottom: clamp(10px, 3vw, 15px); }
    @media (min-width: 480px) { .elevation-header { flex-direction: row; justify-content: space-between; align-items: center; gap: 0; } }
    
    .elevation-title { font-size: clamp(12px, 3vw, 14px); font-weight: 600; color: var(--text-light); display: flex; align-items: center; gap: clamp(6px, 1.5vw, 8px); }
    .elevation-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: clamp(8px, 2vw, 10px); margin-top: clamp(10px, 3vw, 15px); }
    .elevation-stat { text-align: center; padding: clamp(8px, 2vw, 10px); background: rgba(255, 255, 255, 0.05); border-radius: clamp(8px, 2vw, 10px); }
    .elevation-value { font-size: clamp(14px, 4vw, 18px); font-weight: 700; color: var(--text-light); margin: clamp(3px, 1vw, 5px) 0; }
    .elevation-label { font-size: clamp(9px, 2.5vw, 11px); color: var(--text-dim); text-transform: uppercase; }
    #elevation-chart { width: 100% !important; height: clamp(60px, 15vw, 80px) !important; background: rgba(255,255,255,0.05); border-radius: clamp(6px, 2vw, 8px); touch-action: none; }

    .info-panel {
      background: var(--card-bg); backdrop-filter: blur(15px) saturate(180%); -webkit-backdrop-filter: blur(15px) saturate(180%);
      padding: clamp(12px, 3vw, 18px); border-radius: clamp(12px, 3vw, 18px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.08); animation: fadeIn 0.8s ease-out 0.4s both; margin-bottom: 20px; flex-shrink: 0;
    }
    .info-row { display: flex; flex-direction: column; gap: 6px; padding: clamp(8px, 2vw, 12px) 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
    @media (min-width: 480px) { .info-row { flex-direction: row; justify-content: space-between; align-items: center; gap: 0; } }
    .info-row:last-child { border-bottom: none; }
    .info-label { font-size: clamp(12px, 3vw, 14px); color: var(--text-dim); display: flex; align-items: center; gap: clamp(8px, 2vw, 10px); }
    .info-value { font-size: clamp(13px, 3.5vw, 15px); font-weight: 600; color: var(--text-light); text-align: right; }
    .connection-status { display: flex; align-items: center; gap: clamp(6px, 1.5vw, 8px); font-size: clamp(11px, 3vw, 13px); }
    .connection-dot { width: clamp(8px, 2vw, 10px); height: clamp(8px, 2vw, 10px); border-radius: 50%; background-color: var(--success); animation: pulse 2s infinite; }

    .leaflet-control-layers { background: var(--card-bg) !important; color: var(--text-light) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; border-radius: clamp(8px, 2vw, 12px) !important; backdrop-filter: blur(10px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3) !important; }
    .leaflet-control-zoom a { background: var(--card-bg) !important; color: var(--text-light) !important; border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important; width: clamp(36px, 8vw, 44px) !important; height: clamp(36px, 8vw, 44px) !important; line-height: clamp(36px, 8vw, 44px) !important; }

    .strava-marker {
      background: linear-gradient(135deg, var(--strava-orange), #FF8C00); width: clamp(28px, 6vw, 32px); height: clamp(28px, 6vw, 32px);
      border-radius: 50% 50% 50% 0; transform: rotate(-45deg); box-shadow: 0 0 20px rgba(252, 76, 2, 0.8);
      display: flex; align-items: center; justify-content: center; animation: markerPulse 3s infinite, markerFloat 4s infinite ease-in-out;
      border: 3px solid white; position: relative;
    }
    .strava-marker::after { content: 'üèîÔ∏è'; transform: rotate(45deg); font-size: clamp(12px, 3vw, 14px); position: absolute; }
    .strava-path { stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
    
    @keyframes slideInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 5px rgba(252, 76, 2, 0.5); } 50% { box-shadow: 0 0 15px rgba(252, 76, 2, 0.8); } }
    @keyframes markerPulse { 0% { box-shadow: 0 0 0 0 rgba(252, 76, 2, 0.7); } 70% { box-shadow: 0 0 0 clamp(15px, 4vw, 20px) rgba(252, 76, 2, 0); } 100% { box-shadow: 0 0 0 0 rgba(252, 76, 2, 0); } }
    @keyframes markerFloat { 0%, 100% { transform: rotate(-45deg) translateY(0); } 50% { transform: rotate(-45deg) translateY(-8px); } }
    @keyframes progressPulse { 0% { box-shadow: 0 0 0 0 rgba(252, 76, 2, 0.4); } 70% { box-shadow: 0 0 0 clamp(6px, 2vw, 8px) rgba(252, 76, 2, 0); } 100% { box-shadow: 0 0 0 0 rgba(252, 76, 2, 0); } }
    @keyframes drawLine { to { stroke-dashoffset: 0; } }

    .toggle-container { position: fixed; bottom: clamp(80px, 20vw, 100px); right: clamp(10px, 3vw, 20px); z-index: 1001; display: flex; flex-direction: column; gap: clamp(8px, 2vw, 10px); }
    .toggle-btn {
      background: var(--card-bg); color: var(--text-light); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50%;
      width: clamp(44px, 10vw, 50px); height: clamp(44px, 10vw, 50px); display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: clamp(18px, 4vw, 20px); transition: all 0.3s; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .toggle-btn:hover { background: rgba(252, 76, 2, 0.2); transform: scale(1.1); border-color: var(--strava-orange); }
    .toggle-btn.active { background: rgba(252, 76, 2, 0.3); color: var(--strava-orange); border-color: var(--strava-orange); }

    .leaflet-popup-content { min-width: min(200px, 80vw) !important; max-width: min(300px, 90vw) !important; font-size: clamp(12px, 3vw, 14px) !important; }
    .leaflet-popup-content-wrapper { border-radius: clamp(8px, 2vw, 12px) !important; }
    
    .scroll-hint {
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(252, 76, 2, 0.2);
      color: var(--strava-orange); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600;
      backdrop-filter: blur(10px); border: 1px solid rgba(252, 76, 2, 0.3); animation: fadeInOut 3s infinite; display: none; pointer-events: none; z-index: 1003;
    }
    @keyframes fadeInOut { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    @media (max-width: 768px) and (max-height: 800px) { .scroll-hint { display: block; } }
    .dashboard-container { will-change: transform; transform: translateZ(0); }
    @media (min-width: 1024px) { .dashboard-container { max-width: 400px; left: 20px; right: auto; top: 20px; max-height: calc(100vh - 40px); } .toggle-container { right: 20px; } }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="scroll-hint"><i class="fas fa-chevron-down"></i> Scroll untuk lebih banyak info</div>
    <div class="dashboard-container" id="scrollable-dashboard">
      <div class="dashboard-header">
        <div class="header-top">
          <div class="logo-title">
            <div class="logo-icon"><i class="fas fa-mountain"></i></div>
            <div class="title-section"><h1 id="hiker-name">MOUNTAIN TRACKER</h1><p>Live Hiking Activity - Strava Style</p></div>
          </div>
          <div class="live-indicator"><div class="live-dot"></div><span class="live-text">RECORDING</span></div>
        </div>
        
        <!-- HIKER SELECTOR DROPDOWN -->
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <label for="hiker-select" style="font-size: clamp(11px, 3vw, 13px); font-weight: 600; color: var(--text-light); display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-users"></i> Pilih Pendaki:
          </label>
          <select id="hiker-select" style="
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-light);
            border: 1px solid rgba(252, 76, 2, 0.3);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: clamp(11px, 3vw, 13px);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
          ">
            <option value="">-- Tunggu Pendaki Terdaftar --</option>
          </select>
          <span id="active-hiker-badge" style="
            background: rgba(252, 76, 2, 0.3);
            color: var(--strava-orange);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: clamp(10px, 2.5vw, 11px);
            font-weight: 700;
            border: 1px solid rgba(252, 76, 2, 0.4);
            display: none;
          ">AKTIF</span>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label"><i class="fas fa-route"></i> JARAK</div><span class="stat-value" id="distance-val">0.00 km</span></div>
          <div class="stat-card"><div class="stat-label"><i class="fas fa-clock"></i> WAKTU</div><span class="stat-value" id="duration-val">00:00:00</span></div>
          <div class="stat-card"><div class="stat-label"><i class="fas fa-tachometer-alt"></i> KECEPATAN</div><span class="stat-value" id="avg-speed">0.0 km/jam</span></div>
          <div class="stat-card"><div class="stat-label"><i class="fas fa-mountain"></i> ELEVASI</div><span class="stat-value" id="elevation-val">0 m</span></div>
        </div>
        <div class="distance-progress">
          <div class="progress-header"><div class="progress-title"><i class="fas fa-chart-line"></i> Progress Perjalanan</div><div class="progress-percentage" id="distance-percentage">0%</div></div>
          <div class="progress-bar"><div class="progress-fill" id="distance-progress-bar"></div></div>
          <div class="progress-labels"><span>Start</span><span id="current-distance">0 km</span><span id="target-distance">10 km</span></div>
        </div>
      </div>
      <div class="elevation-panel">
        <div class="elevation-header"><div class="elevation-title"><i class="fas fa-chart-area"></i> Profil Elevasi</div><div class="elevation-value" id="total-elevation">+0 m</div></div>
        <canvas id="elevation-chart" width="340" height="80"></canvas>
        <div class="elevation-stats">
          <div class="elevation-stat"><div class="elevation-value" id="min-elevation">0 m</div><div class="elevation-label">Min</div></div>
          <div class="elevation-stat"><div class="elevation-value" id="avg-elevation">0 m</div><div class="elevation-label">Rata-rata</div></div>
          <div class="elevation-stat"><div class="elevation-value" id="max-elevation">0 m</div><div class="elevation-label">Max</div></div>
        </div>
      </div>
      <div class="info-panel">
        <div class="info-row"><div class="info-label"><i class="fas fa-satellite-dish"></i> Status Tracking</div><div class="connection-status"><div class="connection-dot"></div><span class="info-value" id="connection-status">Aktif</span></div></div>
        <div class="info-row"><div class="info-label"><i class="fas fa-map-marker-alt"></i> Posisi Terkini</div><span class="info-value" id="position-val">-7.5, 110.5</span></div>
        <div class="info-row"><div class="info-label"><i class="fas fa-calendar-alt"></i> Mulai Perjalanan</div><span class="info-value" id="start-time">--:--:--</span></div>
        <div class="info-row"><div class="info-label"><i class="fas fa-bolt"></i> Kalori Terbakar</div><span class="info-value" id="calories-val">0 kcal</span></div>
      </div>
    </div>
    <div style="height: 100px; flex-shrink: 0;"></div>
  </div>
  <div class="toggle-container">
    <div class="toggle-btn active" id="toggle-path" title="Tampilkan/Sembunyikan Jalur"><i class="fas fa-route"></i></div>
    <div class="toggle-btn" id="toggle-elevation" title="Tampilkan/Sembunyikan Elevasi"><i class="fas fa-mountain"></i></div>
    <div class="toggle-btn" id="toggle-marker" title="Tampilkan/Sembunyikan Marker"><i class="fas fa-map-marker-alt"></i></div>
    <div class="toggle-btn" id="toggle-fullscreen" title="Layar Penuh"><i class="fas fa-expand"></i></div>
  </div>
  <div id="map"></div>
  
  <script type="module">
    // Import yang kompatibel dengan browser, menggunakan credential SmartHiker kamu
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";

    // --- CONFIG FIREBASE SMARTHIKER ---
    const firebaseConfig = {
      apiKey: "AIzaSyAFUXPpKxImJKhhm5MjQULk9dxFSzrpNIE",
      authDomain: "smarthiker.firebaseapp.com",
      databaseURL: "https://smarthiker-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smarthiker",
      storageBucket: "smarthiker.firebasestorage.app",
      messagingSenderId: "342510258380",
      appId: "1:342510258380:web:71d4c1c3f3d544cf669a69",
      measurementId: "G-C5R3NRZ1SC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const analytics = getAnalytics(app);

    // --- LOGIC LEAFLET & VISUALISASI (STRAVA STYLE) ---
    // Deteksi apakah online atau offline untuk memilih map source
    const mapUrl = navigator.onLine ? 
                   'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png' : 
                   'tiles/{z}/{x}/{y}.png';
    
    const outdoorMap = L.tileLayer(mapUrl, { maxZoom: 17, attribution: '¬© OpenTopoMap', errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7' });
    const stravaHeatmap = L.tileLayer('https://heatmap-external-{s}.strava.com/tiles-auth/ride/hot/{z}/{x}/{y}.png?px=256', { maxZoom: 17, attribution: '¬© Strava Heatmap', opacity: 0.7 });
    const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' });

    const map = L.map('map', { center: [-7.5, 110.5], zoom: 14, layers: [outdoorMap, stravaHeatmap], zoomControl: false });
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.control.layers({ "Peta Topografi": outdoorMap, "Satelit": satelliteMap }, { "Strava Heatmap": stravaHeatmap }, { position: 'topright', collapsed: true }).addTo(map);

    const stravaMarkerIcon = L.divIcon({ className: 'strava-marker', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
    
    // --- MULTI-USER TRACKING DATA ---
    let hikers = {}; // Objek untuk menyimpan data semua pendaki
    let activeHikerId = null; // ID pendaki yang sedang dipilih
    let pathLayers = {}; // Menyimpan polyline untuk setiap pendaki
    let markerLayers = {}; // Menyimpan marker untuk setiap pendaki
    
    // Warna berbeda untuk setiap pendaki
    const hikerColors = {
      'bella': '#FC4C02',
      'budi': '#1E88E5',
      'rina': '#43A047',
      'ricky': '#FB8C00',
      'default': '#FC4C02'
    };

    function getHikerColor(hikerName) {
      const name = hikerName.toLowerCase();
      return hikerColors[name] || hikerColors['default'];
    }
    
    // --- FUNGSI-FUNGSI UTILITY ---
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
    
    function getElevation(lat, lon) { 
        const base = 500; const variation = Math.sin(lat * 100) * 200 + Math.cos(lon * 100) * 150; 
        return Math.max(100, base + variation + Math.random() * 20); 
    }
    
    function formatDuration(seconds) {
      const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = Math.floor(seconds % 60);
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }
    
    function formatDistance(km) { return km < 1 ? `${(km * 1000).toFixed(0)} m` : `${km.toFixed(2)} km`; }

    function updateDashboardStats(hikerName) {
      if(!hikers[hikerName]) return;
      const data = hikers[hikerName];
      
      document.getElementById('hiker-name').textContent = hikerName.toUpperCase();
      document.getElementById('position-val').textContent = `${data.lastPosition?.lat?.toFixed(5) || '0'}, ${data.lastPosition?.lon?.toFixed(5) || '0'}`;
      document.getElementById('distance-val').textContent = formatDistance(data.totalDistance);
      document.getElementById('current-distance').textContent = formatDistance(data.totalDistance);
      document.getElementById('elevation-val').textContent = `${Math.round(data.totalElevationGain)} m`;
      document.getElementById('total-elevation').textContent = `+${Math.round(data.totalElevationGain)} m`;
      document.getElementById('min-elevation').textContent = `${Math.round(data.minElevation === Infinity ? 0 : data.minElevation)} m`;
      document.getElementById('max-elevation').textContent = `${Math.round(data.maxElevation === -Infinity ? 0 : data.maxElevation)} m`;
      
      if(data.elevations.length > 0) {
        document.getElementById('avg-elevation').textContent = `${Math.round(data.elevations.reduce((a,b)=>a+b,0)/data.elevations.length)} m`;
      }
      
      if(data.startTime) {
        const dur = Math.floor((new Date() - data.startTime) / 1000);
        document.getElementById('duration-val').textContent = formatDuration(dur);
        document.getElementById('start-time').textContent = data.startTime.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        
        const hours = dur / 3600;
        if(data.totalDistance > 0 && hours > 0) {
          document.getElementById('avg-speed').textContent = `${(data.totalDistance/hours).toFixed(1)} km/jam`;
        }
        const cals = Math.round((data.totalDistance * 60) + ((data.totalElevationGain/100)*100));
        document.getElementById('calories-val').textContent = `${cals} kcal`;
      }
      
      const pct = Math.min((data.totalDistance/data.targetDistance)*100, 100);
      document.getElementById('distance-percentage').textContent = `${pct.toFixed(1)}%`;
      document.getElementById('distance-progress-bar').style.width = `${pct}%`;
      
      drawElevationChart(hikerName);
    }

    function drawElevationChart(hikerName) {
      if(!hikers[hikerName]) return;
      const canvas = document.getElementById('elevation-chart'); 
      if(!canvas) return;
      
      const ctx = canvas.getContext('2d'); 
      const els = hikers[hikerName].elevations.slice(-50);
      
      if(els.length < 2) return;
      
      ctx.clearRect(0,0,canvas.width,canvas.height); 
      canvas.width = canvas.offsetWidth; 
      canvas.height = canvas.offsetHeight;
      
      const min = Math.min(...els); 
      const max = Math.max(...els); 
      const range = max - min || 1;
      
      ctx.beginPath(); 
      ctx.moveTo(0, canvas.height);
      els.forEach((e,i) => { 
        ctx.lineTo((i/(els.length-1))*canvas.width, canvas.height - ((e-min)/range)*canvas.height*0.8); 
      });
      ctx.lineTo(canvas.width, canvas.height); 
      ctx.closePath();
      
      const grad = ctx.createLinearGradient(0,0,0,canvas.height); 
      grad.addColorStop(0, 'rgba(252,76,2,0.3)'); 
      grad.addColorStop(1, 'rgba(252,76,2,0.05)');
      ctx.fillStyle = grad; 
      ctx.fill();
      
      ctx.beginPath();
      els.forEach((e,i) => { 
        const x = (i/(els.length-1))*canvas.width; 
        const y = canvas.height - ((e-min)/range)*canvas.height*0.8;
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y); 
      });
      ctx.strokeStyle = '#FC4C02'; 
      ctx.lineWidth = 2; 
      ctx.stroke();
    }

    function drawPath(hikerName) {
      if(!hikers[hikerName]) return;
      const data = hikers[hikerName];
      
      if(pathLayers[hikerName]) {
        map.removeLayer(pathLayers[hikerName]);
      }
      
      if(data.positions.length < 2) return;
      
      const latlngs = data.positions.map(p => [p.lat, p.lon]);
      const color = getHikerColor(hikerName);
      const polyline = L.polyline(latlngs, { 
        color: color, 
        weight: 4, 
        opacity: 0.9, 
        lineJoin: 'round', 
        className: 'strava-path'
      });
      
      pathLayers[hikerName] = polyline;
      if(activeHikerId === hikerName) {
        polyline.addTo(map);
      }
    }

    function initializeHiker(hikerName) {
      if(hikers[hikerName]) return;
      
      hikers[hikerName] = {
        marker: null,
        path: null,
        history: [],
        distance: 0,
        startTime: new Date(),
        lastPosition: null,
        totalDistance: 0,
        positions: [],
        elevations: [],
        totalElevationGain: 0,
        minElevation: Infinity,
        maxElevation: -Infinity,
        targetDistance: 10
      };
      
      // Update hiker selector dropdown
      const select = document.getElementById('hiker-select');
      const option = document.createElement('option');
      option.value = hikerName;
      option.textContent = hikerName.toUpperCase();
      select.appendChild(option);
      
      // Jika ini pendaki pertama, set sebagai active
      if(!activeHikerId) {
        activeHikerId = hikerName;
        select.value = hikerName;
        document.getElementById('active-hiker-badge').style.display = 'inline-block';
        updateDashboardStats(hikerName);
      }
    }

    // --- FIREBASE LISTENER (MULTI-USER SUPPORT) ---
    // Ubah ke /hikers (jamak) untuk mendeteksi semua pendaki
    const hikersRef = ref(db, 'hikers');
    onValue(hikersRef, (snapshot) => {
      const allData = snapshot.val();
      if(!allData) {
        document.getElementById('connection-status').textContent = "Menunggu Data...";
        document.querySelector('.connection-dot').style.backgroundColor = "#FF9800";
        return;
      }

      // Iterasi semua pendaki dari Firebase
      Object.keys(allData).forEach(hikerName => {
        const data = allData[hikerName];
        if(!data.lat || !data.lon) return;
        
        const lat = parseFloat(data.lat);
        const lon = parseFloat(data.lon);
        
        // Inisialisasi pendaki jika belum ada
        if(!hikers[hikerName]) {
          initializeHiker(hikerName);
        }
        
        const hikerData = hikers[hikerName];
        
        if(!hikerData.startTime) {
          hikerData.startTime = new Date();
        }
        
        const el = getElevation(lat, lon);
        hikerData.elevations.push(el);
        hikerData.minElevation = Math.min(hikerData.minElevation, el);
        hikerData.maxElevation = Math.max(hikerData.maxElevation, el);
        
        if(hikerData.lastPosition) {
          const dist = calculateDistance(hikerData.lastPosition.lat, hikerData.lastPosition.lon, lat, lon);
          if(dist > 0.001) {
            hikerData.totalDistance += dist;
            const prevEl = hikerData.positions[hikerData.positions.length-1]?.elevation || el;
            if(el > prevEl) hikerData.totalElevationGain += (el - prevEl);
            hikerData.positions.push({lat, lon, elevation: el});
            hikerData.lastPosition = {lat, lon};
            drawPath(hikerName);
          }
        } else {
          hikerData.lastPosition = {lat, lon};
          hikerData.positions.push({lat, lon, elevation: el});
        }
        
        // Update marker untuk pendaki ini
        const newLatLng = [lat, lon];
        if(!hikerData.marker) {
          hikerData.marker = L.marker(newLatLng, {icon: stravaMarkerIcon});
          hikerData.marker.bindPopup(`<b>${hikerName.toUpperCase()}</b><br>Tracking Aktif`);
          if(activeHikerId === hikerName) {
            hikerData.marker.addTo(map);
          }
        } else {
          hikerData.marker.setLatLng(newLatLng);
        }
        
        // Update dashboard jika pendaki ini adalah yang aktif
        if(activeHikerId === hikerName) {
          updateDashboardStats(hikerName);
          if(hikerData.positions.length % 5 === 0) map.panTo(newLatLng);
        }
        
        // Update status koneksi
        document.getElementById('connection-status').textContent = "Aktif";
        document.querySelector('.connection-dot').style.backgroundColor = "#4CAF50";
      });
    });

    // --- HIKER SELECTOR EVENT ---
    document.getElementById('hiker-select').addEventListener('change', function(e) {
      const selectedHiker = this.value;
      if(!selectedHiker) return;
      
      // Hapus marker dan path dari pendaki sebelumnya
      if(activeHikerId && hikers[activeHikerId]) {
        if(hikers[activeHikerId].marker) map.removeLayer(hikers[activeHikerId].marker);
        if(pathLayers[activeHikerId]) map.removeLayer(pathLayers[activeHikerId]);
      }
      
      // Set pendaki baru sebagai active
      activeHikerId = selectedHiker;
      
      // Tambah marker dan path untuk pendaki baru ke map
      if(hikers[selectedHiker]) {
        if(hikers[selectedHiker].marker) hikers[selectedHiker].marker.addTo(map);
        if(pathLayers[selectedHiker]) pathLayers[selectedHiker].addTo(map);
        
        // Update dashboard
        updateDashboardStats(selectedHiker);
        
        // Pan ke lokasi pendaki
        if(hikers[selectedHiker].lastPosition) {
          map.panTo([hikers[selectedHiker].lastPosition.lat, hikers[selectedHiker].lastPosition.lon]);
        }
      }
    });

    // --- CONTROLS & EVENTS ---
    let pathVisible = true;
    let markerVisible = true;
    let elevationVisible = true;

    document.getElementById('toggle-path').onclick = function() { 
      pathVisible = !pathVisible; 
      this.classList.toggle('active'); 
      if(activeHikerId && pathLayers[activeHikerId]) {
        if(pathVisible) pathLayers[activeHikerId].addTo(map);
        else map.removeLayer(pathLayers[activeHikerId]);
      }
    };

    document.getElementById('toggle-elevation').onclick = function() { 
      elevationVisible = !elevationVisible;
      document.querySelector('.elevation-panel').style.display = elevationVisible ? 'block' : 'none'; 
      this.classList.toggle('active'); 
    };

    document.getElementById('toggle-marker').onclick = function() { 
      markerVisible = !markerVisible; 
      this.classList.toggle('active'); 
      if(activeHikerId && hikers[activeHikerId] && hikers[activeHikerId].marker) {
        if(markerVisible) hikers[activeHikerId].marker.addTo(map);
        else map.removeLayer(hikers[activeHikerId].marker);
      }
    };

    document.getElementById('toggle-fullscreen').onclick = function() { 
      document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen(); 
    };
    
    // Auto Update Timer
    setInterval(() => {
      if(activeHikerId && hikers[activeHikerId]) {
        updateDashboardStats(activeHikerId);
      }
    }, 1000);
    
    // Deteksi perubahan status koneksi
    window.addEventListener('online', () => {
      console.log("Back Online");
      document.getElementById('connection-status').textContent = "Online - Peta Streaming";
    });

    window.addEventListener('offline', () => {
      console.log("Offline Mode");
      document.getElementById('connection-status').textContent = "Offline - Peta Lokal";
      document.querySelector('.connection-dot').style.backgroundColor = "#FF9800";
    });
  </script>
</body>
</html>